<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Adseum Letter Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        .cell {
            width: 30px;
            height: 30px;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
        }

        .cell.active {
            background-color: #000;
        }

        .cell:hover {
            background-color: #f3f4f6;
        }

        .cell.active:hover {
            background-color: #333;
        }
    </style>
</head>

<body class="bg-gray-50 flex h-screen overflow-hidden font-mono">

    <!-- Sidebar / Controls -->
    <div class="w-1/3 bg-white border-r p-8 flex flex-col gap-6 overflow-y-auto">
        <h1 class="text-2xl font-bold mb-4">Letter Builder</h1>

        <div>
            <label class="block text-sm font-bold mb-2">Load Existing:</label>
            <div class="flex flex-wrap gap-2" id="letter-buttons">
                <!-- Buttons injected here -->
            </div>
        </div>

        <div>
            <label class="block text-sm font-bold mb-2">Grid Dimensions:</label>
            <div class="flex gap-2 mb-2">
                <div class="w-1/2">
                    <label class="text-xs text-gray-500">Rows</label>
                    <input type="number" id="grid-rows" value="11" class="w-full border p-2 rounded text-sm">
                </div>
                <div class="w-1/2">
                    <label class="text-xs text-gray-500">Cols</label>
                    <input type="number" id="grid-cols" value="7" class="w-full border p-2 rounded text-sm">
                </div>
            </div>
            <button onclick="updateGridSize()"
                class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 rounded text-xs transition">Update Grid
                Size</button>
        </div>

        <div>
            <label class="block text-sm font-bold mb-2">Usage:</label>
            <p class="text-xs text-gray-600">Click cells to toggle dots.</p>
        </div>

        <div class="mt-auto border-t pt-4">
            <label class="block text-sm font-bold mb-2">Add to Collection:</label>
            <input type="text" id="letter-name" placeholder="Letter Name (e.g. F)"
                class="w-full border p-2 rounded text-sm mb-2" maxlength="1">
            <div class="flex gap-2 mb-2">
                <button onclick="addToAlphabet()"
                    class="flex-1 bg-black text-white py-2 rounded hover:bg-gray-800 transition">Save / Update</button>
                <button onclick="deleteLetter()"
                    class="bg-red-500 text-white px-3 py-2 rounded hover:bg-red-600 transition" title="Delete Letter">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </button>
            </div>

            <hr class="my-4">

            <button onclick="downloadLettersJS()"
                class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 transition text-xs flex justify-center items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Download letters.js
            </button>
        </div>
    </div>

    <!-- Main Editor Area -->
    <div class="flex-1 flex flex-col items-center justify-center bg-gray-50 relative">

        <!-- Editor Grid -->
        <div class="mb-12">
            <div class="text-center mb-2 font-bold text-gray-400">EDITOR</div>
            <div id="editor-grid" class="grid bg-white border shadow-sm p-4 gap-1">
                <!-- Grid generated by JS -->
            </div>
        </div>

        <!-- Live Preview -->
        <div>
            <div class="text-center mb-2 font-bold text-gray-400">PREVIEW</div>
            <div id="preview-container"
                class="bg-white border p-8 shadow-sm rounded-lg min-h-[150px] flex items-center justify-center">
                <!-- Preview Rendered Here -->
            </div>
        </div>

    </div>

    <!-- Import Main Script for shared logic (createDot etc) -->
    <script src="letters.js"></script>
    <script src="script.js"></script>

    <script>
        // --- Core Editor Logic (Works Offline) ---
        let ROWS = 11;
        let COLS = 7;
        let currentGrid = Array(ROWS).fill().map(() => Array(COLS).fill(0));

        const editorGrid = document.getElementById('editor-grid');
        const letterNameInput = document.getElementById('letter-name');
        const previewContainer = document.getElementById('preview-container');
        const letterButtons = document.getElementById('letter-buttons');
        const rowsInput = document.getElementById('grid-rows');
        const colsInput = document.getElementById('grid-cols');

        function initEditor(preserveData = false) {
            rowsInput.value = ROWS;
            colsInput.value = COLS;
            editorGrid.innerHTML = '';
            editorGrid.style.gridTemplateColumns = `repeat(${COLS}, 30px)`;

            if (!preserveData) {
                currentGrid = Array(ROWS).fill().map(() => Array(COLS).fill(0));
            }

            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    if (currentGrid[r] && currentGrid[r][c]) {
                        cell.classList.add('active');
                    }
                    cell.dataset.r = r;
                    cell.dataset.c = c;
                    cell.addEventListener('mousedown', () => toggleCell(r, c, cell));
                    editorGrid.appendChild(cell);
                }
            }
            updatePreview();
        }

        function updateGridSize() {
            const newRows = parseInt(rowsInput.value) || 11;
            const newCols = parseInt(colsInput.value) || 7;
            const newGrid = Array(newRows).fill().map(() => Array(newCols).fill(0));

            for (let r = 0; r < Math.min(ROWS, newRows); r++) {
                for (let c = 0; c < Math.min(COLS, newCols); c++) {
                    newGrid[r][c] = currentGrid[r][c];
                }
            }

            ROWS = newRows;
            COLS = newCols;
            currentGrid = newGrid;
            initEditor(true);
        }

        function toggleCell(r, c, cell) {
            currentGrid[r][c] = currentGrid[r][c] ? 0 : 1;
            cell.classList.toggle('active');
            updatePreview();
        }

        function loadLetter(char) {
            if (!window.letters[char]) return;
            const data = window.letters[char];
            ROWS = data.length;
            COLS = data[0].length;
            currentGrid = JSON.parse(JSON.stringify(data));

            // Pre-fill name input for easier editing/deleting
            letterNameInput.value = char;

            initEditor(true);
        }

        function updatePreview() {
            previewContainer.innerHTML = '';
            if (typeof renderLetter === 'function') {
                const rendered = renderLetter('custom', currentGrid);
                previewContainer.appendChild(rendered);
                if (typeof gsap !== 'undefined') {
                    gsap.fromTo("#preview-container .dot-wrapper svg",
                        { scale: 0, opacity: 0 },
                        { scale: 1, opacity: 1, duration: 0.4, stagger: 0.02, ease: "back.out(1.7)" }
                    );
                }
            }
        }

        function refreshLetterButtons() {
            letterButtons.innerHTML = '';
            if (window.letters) {
                Object.keys(window.letters).forEach(char => {
                    const btn = document.createElement('button');
                    btn.className = "px-3 py-1 border rounded hover:bg-gray-100 text-sm";
                    btn.innerText = char;
                    btn.onclick = () => loadLetter(char);
                    letterButtons.appendChild(btn);
                });
            }
        }

        function downloadLettersJS() {
            const content = `// Letter Definitions (1 = dot, 0 = space)\n// Generated by Letter Builder\nconst letters = ${JSON.stringify(window.letters, null, 4)};\nwindow.letters = letters;\n`;
            const blob = new Blob([content], { type: 'text/javascript' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'letters.js';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Initialize core features immediately
        initEditor();
        updatePreview();
        refreshLetterButtons();
    </script>

    <script type="module">
        import { db } from './firebase-config.js';
        import { doc, setDoc, deleteDoc, getDocs, collection } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // Attach Firebase functions to window
        window.addToAlphabet = async function () {
            const name = letterNameInput.value.trim();
            if (!name) {
                alert('Please enter a letter name!');
                return;
            }

            const btn = document.querySelector('button[onclick="addToAlphabet()"]');
            let originalText = "Save / Update";
            if (btn) {
                originalText = btn.innerText;
                btn.innerText = "Saving...";
                btn.disabled = true;
            }

            try {
                const gridData = {};
                currentGrid.forEach((row, index) => {
                    gridData[`row${index}`] = row;
                });

                await setDoc(doc(db, "letters", name), {
                    rows: ROWS,
                    cols: COLS,
                    gridData: gridData
                });

                window.letters[name] = JSON.parse(JSON.stringify(currentGrid));
                refreshLetterButtons();
                alert(`Letter "${name}" saved!`);
                // Keep input value for further edits
            } catch (e) {
                console.error("Error adding letter: ", e);
                alert("Error saving letter. See console. (If running locally without a server, Firestore won't work)");
            } finally {
                if (btn) {
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            }
        };

        window.deleteLetter = async function () {
            const name = letterNameInput.value.trim();
            if (!name) {
                alert('Please load or name a letter to delete.');
                return;
            }

            if (!confirm(`Are you sure you want to delete the letter "${name}"? This cannot be undone.`)) {
                return;
            }

            try {
                await deleteDoc(doc(db, "letters", name));
                delete window.letters[name];
                refreshLetterButtons();

                letterNameInput.value = '';
                // Reset grid? Optional. Let's keep it but maybe clear selection.
                alert(`Letter "${name}" deleted.`);
            } catch (e) {
                console.error("Error deleting letter:", e);
                alert("Error deleting letter. See console.");
            }
        };

        // Load letters from Firestore
        async function loadFromFirestore() {
            try {
                const querySnapshot = await getDocs(collection(db, "letters"));
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.gridData) {
                        const reconstructedGrid = [];
                        for (let i = 0; i < data.rows; i++) {
                            reconstructedGrid.push(data.gridData[`row${i}`]);
                        }
                        window.letters[doc.id] = reconstructedGrid;
                    } else if (data.grid) {
                        window.letters[doc.id] = data.grid;
                    }
                });
                refreshLetterButtons();
            } catch (e) {
                console.error("Error loading letters from Firestore (likely offline/CORS):", e);
            }
        }

        loadFromFirestore();
    </script>
</body>

</html>